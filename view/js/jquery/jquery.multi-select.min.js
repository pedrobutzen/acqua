!function(e){"use strict";var t=function(t,n){this.options=n;this.$element=e(t);this.$container=e("<div/>",{"class":"ms-container"});this.$selectableContainer=e("<div/>",{"class":"ms-selectable"});this.$selectionContainer=e("<div/>",{"class":"ms-selection"});this.$selectableUl=e("<ul/>",{"class":"ms-list",tabindex:"-1"});this.$selectionUl=e("<ul/>",{"class":"ms-list",tabindex:"-1"});this.scrollTo=0;this.elemsSelector="li:visible:not(.ms-optgroup-label,.ms-optgroup-container,."+n.disabledClass+")"};t.prototype={constructor:t,init:function(){var t=this,n=this.$element;if(n.next(".ms-container").length===0){n.css({position:"absolute",left:"-9999px"});n.attr("id",n.attr("id")?n.attr("id"):Math.ceil(Math.random()*1e3)+"multiselect");this.$container.attr("id","ms-"+n.attr("id"));this.$container.addClass(t.options.cssClass);n.find("option").each(function(){t.generateLisFromOption(this)});this.$selectionUl.find(".ms-optgroup-label").hide();if(t.options.selectableHeader){t.$selectableContainer.append(t.options.selectableHeader)}t.$selectableContainer.append(t.$selectableUl);if(t.options.selectableFooter){t.$selectableContainer.append(t.options.selectableFooter)}if(t.options.selectionHeader){t.$selectionContainer.append(t.options.selectionHeader)}t.$selectionContainer.append(t.$selectionUl);if(t.options.selectionFooter){t.$selectionContainer.append(t.options.selectionFooter)}t.$container.append(t.$selectableContainer);t.$container.append(t.$selectionContainer);n.after(t.$container);t.activeMouse(t.$selectableUl);t.activeKeyboard(t.$selectableUl);var r=t.options.dblClick?"dblclick":"click";t.$selectableUl.on(r,".ms-elem-selectable",function(){t.select(e(this).data("ms-value"))});t.$selectionUl.on(r,".ms-elem-selection",function(){t.deselect(e(this).data("ms-value"))});t.activeMouse(t.$selectionUl);t.activeKeyboard(t.$selectionUl);n.on("focus",function(){t.$selectableUl.focus()})}var i=n.find("option:selected").map(function(){return e(this).val()}).get();t.select(i,"init");if(typeof t.options.afterInit==="function"){t.options.afterInit.call(this,this.$container)}},generateLisFromOption:function(t,n,r){var i=this,s=i.$element,o="",u=e(t);for(var a=0;a<t.attributes.length;a++){var f=t.attributes[a];if(f.name!=="value"&&f.name!=="disabled"){o+=f.name+'="'+f.value+'" '}}var l=e("<li "+o+"><span>"+i.escapeHTML(u.text())+"</span></li>"),c=l.clone(),h=u.val(),p=i.sanitize(h);l.data("ms-value",h).addClass("ms-elem-selectable").attr("id",p+"-selectable");c.data("ms-value",h).addClass("ms-elem-selection").attr("id",p+"-selection").hide();if(u.prop("disabled")||s.prop("disabled")){c.addClass(i.options.disabledClass);l.addClass(i.options.disabledClass)}var d=u.parent("optgroup");if(d.length>0){var v=d.attr("label"),m=i.sanitize(v),g=i.$selectableUl.find("#optgroup-selectable-"+m),y=i.$selectionUl.find("#optgroup-selection-"+m);if(g.length===0){var b='<li class="ms-optgroup-container"></li>',w='<ul class="ms-optgroup"><li class="ms-optgroup-label"><span>'+v+"</span></li></ul>";g=e(b);y=e(b);g.attr("id","optgroup-selectable-"+m);y.attr("id","optgroup-selection-"+m);g.append(e(w));y.append(e(w));if(i.options.selectableOptgroup){g.find(".ms-optgroup-label").on("click",function(){var t=d.children(":not(:selected, :disabled)").map(function(){return e(this).val()}).get();i.select(t)});y.find(".ms-optgroup-label").on("click",function(){var t=d.children(":selected:not(:disabled)").map(function(){return e(this).val()}).get();i.deselect(t)})}i.$selectableUl.append(g);i.$selectionUl.append(y)}n=n==undefined?g.find("ul").children().length:n+1;l.insertAt(n,g.children());c.insertAt(n,y.children())}else{n=n==undefined?i.$selectableUl.children().length:n;l.insertAt(n,i.$selectableUl);c.insertAt(n,i.$selectionUl)}},addOption:function(t){var n=this;if(t.value)t=[t];e.each(t,function(t,r){if(r.value&&n.$element.find("option[value='"+r.value+"']").length===0){var i=e('<option value="'+r.value+'">'+r.text+"</option>"),t=parseInt(typeof r.index==="undefined"?n.$element.children().length:r.index),s=r.nested==undefined?n.$element:e("optgroup[label='"+r.nested+"']");i.insertAt(t,s);n.generateLisFromOption(i.get(0),t,r.nested)}})},escapeHTML:function(t){return e("<div>").text(t).html()},activeKeyboard:function(t){var n=this;t.on("focus",function(){e(this).addClass("ms-focus")}).on("blur",function(){e(this).removeClass("ms-focus")}).on("keydown",function(r){switch(r.which){case 40:case 38:r.preventDefault();r.stopPropagation();n.moveHighlight(e(this),r.which===38?-1:1);return;case 37:case 39:r.preventDefault();r.stopPropagation();n.switchList(t);return;case 9:if(n.$element.is("[tabindex]")){r.preventDefault();var i=parseInt(n.$element.attr("tabindex"),10);i=r.shiftKey?i-1:i+1;e('[tabindex="'+i+'"]').focus();return}else{if(r.shiftKey){n.$element.trigger("focus")}}}if(e.inArray(r.which,n.options.keySelect)>-1){r.preventDefault();r.stopPropagation();n.selectHighlighted(t);return}})},moveHighlight:function(e,t){var n=e.find(this.elemsSelector),r=n.filter(".ms-hover"),i=null,s=n.first().outerHeight(),o=e.height(),u="#"+this.$container.prop("id");n.removeClass("ms-hover");if(t===1){i=r.nextAll(this.elemsSelector).first();if(i.length===0){var a=r.parent();if(a.hasClass("ms-optgroup")){var f=a.parent(),l=f.next(":visible");if(l.length>0){i=l.find(this.elemsSelector).first()}else{i=n.first()}}else{i=n.first()}}}else if(t===-1){i=r.prevAll(this.elemsSelector).first();if(i.length===0){var a=r.parent();if(a.hasClass("ms-optgroup")){var f=a.parent(),c=f.prev(":visible");if(c.length>0){i=c.find(this.elemsSelector).last()}else{i=n.last()}}else{i=n.last()}}}if(i.length>0){i.addClass("ms-hover");var h=e.scrollTop()+i.position().top-o/2+s/2;e.scrollTop(h)}},selectHighlighted:function(e){var t=e.find(this.elemsSelector),n=t.filter(".ms-hover").first();if(n.length>0){if(e.parent().hasClass("ms-selectable")){this.select(n.data("ms-value"))}else{this.deselect(n.data("ms-value"))}t.removeClass("ms-hover")}},switchList:function(e){e.blur();this.$container.find(this.elemsSelector).removeClass("ms-hover");if(e.parent().hasClass("ms-selectable")){this.$selectionUl.focus()}else{this.$selectableUl.focus()}},activeMouse:function(t){var n=this;e("body").on("mouseenter",n.elemsSelector,function(){e(this).parents(".ms-container").find(n.elemsSelector).removeClass("ms-hover");e(this).addClass("ms-hover")});e("body").on("mouseleave",n.elemsSelector,function(){e(this).parents(".ms-container").find(n.elemsSelector).removeClass("ms-hover");})},refresh:function(){this.destroy();this.$element.multiSelect(this.options)},destroy:function(){e("#ms-"+this.$element.attr("id")).remove();this.$element.css("position","").css("left","");this.$element.removeData("multiselect")},select:function(t,n){if(typeof t==="string"){t=[t]}var r=this,i=this.$element,s=e.map(t,function(e){return r.sanitize(e)}),o=this.$selectableUl.find("#"+s.join("-selectable, #")+"-selectable").filter(":not(."+r.options.disabledClass+")"),u=this.$selectionUl.find("#"+s.join("-selection, #")+"-selection").filter(":not(."+r.options.disabledClass+")"),a=i.find("option:not(:disabled)").filter(function(){return e.inArray(this.value,t)>-1});if(n==="init"){o=this.$selectableUl.find("#"+s.join("-selectable, #")+"-selectable"),u=this.$selectionUl.find("#"+s.join("-selection, #")+"-selection")}if(o.length>0){o.addClass("ms-selected").hide();u.addClass("ms-selected").show();a.prop("selected",true);r.$container.find(r.elemsSelector).removeClass("ms-hover");var f=r.$selectableUl.children(".ms-optgroup-container");if(f.length>0){f.each(function(){var t=e(this).find(".ms-elem-selectable");if(t.length===t.filter(".ms-selected").length){e(this).find(".ms-optgroup-label").hide()}});var l=r.$selectionUl.children(".ms-optgroup-container");l.each(function(){var t=e(this).find(".ms-elem-selection");if(t.filter(".ms-selected").length>0){e(this).find(".ms-optgroup-label").show()}})}else{if(r.options.keepOrder&&n!=="init"){var c=r.$selectionUl.find(".ms-selected");if(c.length>1&&c.last().get(0)!=u.get(0)){u.insertAfter(c.last())}}}if(n!=="init"){i.trigger("change");if(typeof r.options.afterSelect==="function"){r.options.afterSelect.call(this,t)}}}},deselect:function(t){if(typeof t==="string"){t=[t]}var n=this,r=this.$element,i=e.map(t,function(e){return n.sanitize(e)}),s=this.$selectableUl.find("#"+i.join("-selectable, #")+"-selectable"),o=this.$selectionUl.find("#"+i.join("-selection, #")+"-selection").filter(".ms-selected").filter(":not(."+n.options.disabledClass+")"),u=r.find("option").filter(function(){return e.inArray(this.value,t)>-1});if(o.length>0){s.removeClass("ms-selected").show();o.removeClass("ms-selected").hide();u.prop("selected",false);n.$container.find(n.elemsSelector).removeClass("ms-hover");var a=n.$selectableUl.children(".ms-optgroup-container");if(a.length>0){a.each(function(){var t=e(this).find(".ms-elem-selectable");if(t.filter(":not(.ms-selected)").length>0){e(this).find(".ms-optgroup-label").show()}});var f=n.$selectionUl.children(".ms-optgroup-container");f.each(function(){var t=e(this).find(".ms-elem-selection");if(t.filter(".ms-selected").length===0){e(this).find(".ms-optgroup-label").hide()}})}r.trigger("change");if(typeof n.options.afterDeselect==="function"){n.options.afterDeselect.call(this,t)}}},select_all:function(){var t=this.$element,n=t.val();t.find('option:not(":disabled")').prop("selected",true);this.$selectableUl.find(".ms-elem-selectable").filter(":not(."+this.options.disabledClass+")").addClass("ms-selected").hide();this.$selectionUl.find(".ms-optgroup-label").show();this.$selectableUl.find(".ms-optgroup-label").hide();this.$selectionUl.find(".ms-elem-selection").filter(":not(."+this.options.disabledClass+")").addClass("ms-selected").show();this.$selectionUl.focus();t.trigger("change");if(typeof this.options.afterSelect==="function"){var r=e.grep(t.val(),function(t){return e.inArray(t,n)<0});this.options.afterSelect.call(this,r)}},deselect_all:function(){var e=this.$element,t=e.val();e.find("option").prop("selected",false);this.$selectableUl.find(".ms-elem-selectable").removeClass("ms-selected").show();this.$selectionUl.find(".ms-optgroup-label").hide();this.$selectableUl.find(".ms-optgroup-label").show();this.$selectionUl.find(".ms-elem-selection").removeClass("ms-selected").hide();this.$selectableUl.focus();e.trigger("change");if(typeof this.options.afterDeselect==="function"){this.options.afterDeselect.call(this,t)}},sanitize:function(e){var t=0,n,r;if(e.length==0)return t;var i=0;for(n=0,i=e.length;n<i;n++){r=e.charCodeAt(n);t=(t<<5)-t+r;t|=0}return t}};e.fn.multiSelect=function(){var n=arguments[0],r=arguments;return this.each(function(){var i=e(this),s=i.data("multiselect"),o=e.extend({},e.fn.multiSelect.defaults,i.data(),typeof n==="object"&&n);if(!s){i.data("multiselect",s=new t(this,o))}if(typeof n==="string"){s[n](r[1])}else{s.init()}})};e.fn.multiSelect.defaults={keySelect:[32],selectableOptgroup:false,disabledClass:"disabled",dblClick:false,keepOrder:false,cssClass:""};e.fn.multiSelect.Constructor=t;e.fn.insertAt=function(e,t){return this.each(function(){if(e===0){t.prepend(this)}else{t.children().eq(e-1).after(this)}})}}(window.jQuery)